<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Webcam Stream</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“·</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
        html, body {
            color-scheme: dark;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: #444444;
            overflow: hidden;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            display: flex;
            gap: 8px;
            align-items: center;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .controls.hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        .player {
            width: 100vw;
            height: 100vh;
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player video {
            height: 100vh;
            width: auto;
            max-width: 100vw;
            display: block;
            background: black;
        }
        .mute-btn, .hide-controls-btn, .fullscreen-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            background: #333;
            color: #fff;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
            height: 2.25em;
            min-width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fullscreen-btn {
            min-width: 2.25em;
            width: 2.25em;
            height: 2.25em;
            padding: 0;
            font-size: 1.15em;
            background: #222;
            border: 1px solid #555;
            box-sizing: border-box;
        }
        .fullscreen-btn.active {
            background: #246;
        }
        .fullscreen-btn:hover, .fullscreen-btn:focus-visible {
            background: #333;
        }
        .mute-btn.muted {
            background: #a22;
        }
        .mute-btn:focus, .hide-controls-btn:focus, .fullscreen-btn:focus {
            outline: 2px solid #fff;
        }
        #camera-select {
            font-size: 1em;
            font-family: inherit;
            height: 2.25em;
            border-radius: 4px;
            border: 1px solid #888;
            background: #222;
            color: #fff;
            padding: 0 8px;
        }
        #camera-select:focus {
            outline: 2px solid #fff;
        }
        .hide-controls-btn {
            min-width: 2.25em;
            width: 2.25em;
            height: 2.25em;
            padding: 0;
            font-size: 1.15em;
            background: #111;
            border: 1px solid #555;
            box-sizing: border-box;
        }
        .hide-controls-btn:hover, .hide-controls-btn:focus-visible {
            background: #333;
        }
    </style>
</head>
<body>
    <div class="controls" id="controls-bar">
        <button id="hide-controls-btn" class="hide-controls-btn" type="button" title="Hide controls (H)">
            <span id="hide-controls-icon" aria-label="Hide controls">â¬…</span>
        </button>
        <select id="camera-select"></select>
        <button id="mute-btn" class="mute-btn" type="button">Mute</button>
        <button id="fullscreen-btn" class="fullscreen-btn" type="button" title="Fullscreen (F)">
            <span id="fullscreen-icon" aria-label="Fullscreen">â›¶</span>
        </button>
    </div>
    <div class="player" id="player">
        <video id="webcam-stream" autoplay playsinline></video>
    </div>
    <script>
        const webcamStream = document.getElementById("webcam-stream");
        const cameraSelect = document.getElementById("camera-select");
        const muteBtn = document.getElementById("mute-btn");
        const controlsBar = document.getElementById("controls-bar");
        const hideControlsBtn = document.getElementById("hide-controls-btn");
        const hideControlsIcon = document.getElementById("hide-controls-icon");
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        const fullscreenIcon = document.getElementById("fullscreen-icon");
        const player = document.getElementById("player");

        let currentStream = null;
        let audioMuted = false;
        let controlsHidden = false;
        let isFullscreen = false;

        const constraints = {
            audio: true,
            video: {
                width: { min: 1024, ideal: 1280, max: 1920 },
                height: { min: 576, ideal: 720, max: 1080 },
            }
        };

        function stopCurrentStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function getVideoStream(deviceId) {
            const videoConstraints = { ...constraints.video };
            if (deviceId) {
                videoConstraints.deviceId = { exact: deviceId };
            }
            return navigator.mediaDevices.getUserMedia({
                audio: constraints.audio,
                video: videoConstraints
            });
        }

        function populateCameraList(selectedDeviceId = null) {
            navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                const videoDevices = devices.filter(device => device.kind === "videoinput");
                cameraSelect.innerHTML = "";
                videoDevices.forEach((device, idx) => {
                    const option = document.createElement("option");
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${idx + 1}`;
                    cameraSelect.appendChild(option);
                });
                // Select preferred camera if not set
                if (selectedDeviceId) {
                    cameraSelect.value = selectedDeviceId;
                } else {
                    // Prefer USB camera if present
                    let preferredDevice = videoDevices[0];
                    for (const device of videoDevices) {
                        if (/usb/i.test(device.label)) {
                            preferredDevice = device;
                            break;
                        }
                    }
                    cameraSelect.value = preferredDevice.deviceId;
                }
            });
        }

        function updateMuteButtonUI() {
            if (audioMuted) {
                muteBtn.textContent = "Unmute";
                muteBtn.classList.add("muted");
            } else {
                muteBtn.textContent = "Mute";
                muteBtn.classList.remove("muted");
            }
        }

        function setStreamAudioMuted(muted) {
            if (currentStream) {
                currentStream.getAudioTracks().forEach(track => {
                    track.enabled = !muted;
                });
            }
            audioMuted = muted;
            updateMuteButtonUI();
        }

        function toggleMute() {
            audioMuted = !audioMuted;
            setStreamAudioMuted(audioMuted);
        }

        muteBtn.addEventListener("click", toggleMute);

        function startCamera(deviceId) {
            stopCurrentStream();
            getVideoStream(deviceId)
                .then(stream => {
                    currentStream = stream;
                    webcamStream.srcObject = stream;
                    populateCameraList(deviceId);
                    setStreamAudioMuted(audioMuted); // Maintain mute state on stream switch
                })
                .catch(error => {
                    alert("Could not access webcam: " + error.message);
                    console.error(error);
                });
        }

        cameraSelect.addEventListener("change", () => {
            startCamera(cameraSelect.value);
        });

        // HIDE/SHOW CONTROLS LOGIC

        function setControlsHidden(hidden) {
            controlsHidden = hidden;
            if (controlsHidden) {
                controlsBar.classList.add('hidden');
                hideControlsIcon.textContent = 'âž¡';
                hideControlsBtn.title = "Show controls (H)";
            } else {
                controlsBar.classList.remove('hidden');
                hideControlsIcon.textContent = 'â¬…';
                hideControlsBtn.title = "Hide controls (H)";
            }
        }

        hideControlsBtn.addEventListener("click", () => {
            setControlsHidden(!controlsHidden);
        });

        // FULLSCREEN LOGIC

        function setFullscreen(full) {
            isFullscreen = full;
            if (isFullscreen) {
                if (player.requestFullscreen) {
                    player.requestFullscreen();
                } else if (player.webkitRequestFullscreen) {
                    player.webkitRequestFullscreen();
                } else if (player.msRequestFullscreen) {
                    player.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            updateFullscreenButtonUI();
        }

        function updateFullscreenButtonUI() {
            if (isFullscreen) {
                fullscreenBtn.classList.add("active");
                fullscreenIcon.textContent = "ðŸ¡½"; // Contract icon
                fullscreenBtn.title = "Exit fullscreen (F)";
            } else {
                fullscreenBtn.classList.remove("active");
                fullscreenIcon.textContent = "â›¶"; // Expand icon
                fullscreenBtn.title = "Fullscreen (F)";
            }
        }

        fullscreenBtn.addEventListener("click", () => {
            setFullscreen(!isFullscreen);
        });

        // Watch for fullscreen changes (so exiting with ESC updates button)
        document.addEventListener('fullscreenchange', () => {
            isFullscreen = !!document.fullscreenElement;
            updateFullscreenButtonUI();
        });
        document.addEventListener('webkitfullscreenchange', () => {
            isFullscreen = !!document.webkitFullscreenElement;
            updateFullscreenButtonUI();
        });
        document.addEventListener('msfullscreenchange', () => {
            isFullscreen = !!document.msFullscreenElement;
            updateFullscreenButtonUI();
        });

        document.addEventListener("keydown", (e) => {
            // Ignore if focus is in an input/select/textarea or with modifier keys
            if (
                e.altKey || e.ctrlKey || e.metaKey || e.shiftKey ||
                ['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)
            ) return;
            if (e.key === 'h' || e.key === 'H') {
                setControlsHidden(!controlsHidden);
                e.preventDefault();
            }
            if (e.key === 'm' || e.key === 'M') {
                toggleMute();
                e.preventDefault();
            }
            if (e.key === 'f' || e.key === 'F') {
                setFullscreen(!isFullscreen);
                e.preventDefault();
            }
        });

        // Initial camera setup after permission
        function init() {
            getVideoStream()
            .then(stream => {
                currentStream = stream;
                webcamStream.srcObject = stream;
                setStreamAudioMuted(audioMuted);
                return navigator.mediaDevices.enumerateDevices();
            })
            .then(devices => {
                const videoDevices = devices.filter(device => device.kind === "videoinput");
                populateCameraList();
                // Prefer USB camera if present
                let preferredDevice = videoDevices[0];
                for (const device of videoDevices) {
                    if (/usb/i.test(device.label)) {
                        preferredDevice = device;
                        break;
                    }
                }
                // If not already using preferred device, switch
                if (preferredDevice && preferredDevice.deviceId !== currentStream.getVideoTracks()[0].getSettings().deviceId) {
                    startCamera(preferredDevice.deviceId);
                }
            })
            .catch(error => {
                alert("Could not access webcam: " + error.message);
                console.error(error);
            });
        }

        if (
            navigator.mediaDevices &&
            navigator.mediaDevices.getUserMedia &&
            navigator.mediaDevices.enumerateDevices
        ) {
            updateMuteButtonUI();
            setControlsHidden(false);
            updateFullscreenButtonUI();
            init();
        } else {
            alert("Your browser does not support required Media Devices APIs.");
        }
    </script>
</body>
</html>